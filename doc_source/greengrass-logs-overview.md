# Monitoring with AWS Greengrass Logs<a name="greengrass-logs-overview"></a>

AWS Greengrass consists of the cloud service and the AWS Greengrass core software\. The AWS Greengrass core software can write logs to CloudWatch Logs or to the local file system of your AWS Greengrass core device\. If the logging component is configured to log events to the local file system, the log files are stored under /greengrass/ggc/var/log with the following directory structure:

```
/greengrass/ggc/var/log
    - crash.log
    - system
        - log files for each Greengrass system component
    - user
        - log files generated by each Lambda function
```

Currently, for file system logging, we support size\-based rotation and automatic cleanup when the amount of log data is close to the configured limit\.

**Note**  
AWS Greengrass Core Software v1\.0\.0 uses the following directory structure:  

```
/greengrass/var
    - log
    - system
        - log files for each Greengrass system component
    - user
        - log files generated by each Lambda function
```

## Configuring Logging for AWS Greengrass<a name="config-logs"></a>

The logging component can be configured through the Greengrass logging list APIs with a payload similar to the following:

```
{
    "loggingModelList": [
    {
        "Type": "log-storage-type",
        "Component": component-type,
        "Level": logging-level,
        "Space": max-storage
    },
    {
        "Type": ... ,
        "Level": ... ,
        ...
    }
    ]
}
```

`Type`  
The storage mechanism for log events\. When `AWSCloudWatch` is used, log events are sent to CloudWatch with a limited number of retries in case there's no internet connectivity\. After the retries are exhausted, the event is dropped\. When `FileSystem` is used, log events are stored on the local file system\.  
Valid values: `AWSCloudWatch`, `FileSystem`

`Component`  
The source of the log event\. When `GreengrassSystem` is used, events from Greengrass system components are logged\. When `Lambda` is used, events from a user's Lambda functions are logged\.  
Valid values: `GreengrassSystem`, `Lambda`

`Level`  
The log\-level threshold\. Log events below this threshold are filtered out and aren't stored\.  
Valid values: `DEBUG`, `INFO`, `WARN`, `ERROR`, `FATAL`

`Space`  
The maximum amount of local storage, in KB, to use for storing logs\. This field applies only when `Type` is set to `FileSystem`\.

## Default Configuration<a name="config-logs-default"></a>

If logging is not configured before the first deployment, the AWS Greengrass core software does not contain any logging configuration information\. It uses the following settings:

```
[
    {
        "Type": "FileSystem",
        "Component": "GreengrassSystem",
        "Level": "INFO",
        "Space": 128
    }
]
```

After the first deployment, if you explicitly configure the Greengrass software to emit no logs, none will be emitted\. If you don't configure logging, the following settings are used by default:

```
[
    {
        "Type": "FileSystem",
        "Component": "GreengrassSystem",
        "Level": "INFO",
        "Space": 128
    },
    {
        "Type": "FileSystem",
        "Component": "Lambda",
        "Level": "INFO",
        "Space": 128
    }
]
```

## Required IAM Permissions<a name="gg-log-permisions"></a>

To enable logging to CloudWatch, the following CloudWatch Logs actions must be present in the AWS Greengrass group role:
+ logs:PutLogEvents
+ logs:CreateLogGroup
+ logs:CreateLogStream
+ logs:DescribeLogStreams

## Logging Output<a name="logging-output"></a>

If the logging component is configured to write logs to CloudWatch, the following log groups are displayed:

```
/aws/greengrass/GreengrassSystem/GreengrassSystemComponentName
/aws/greengrass/Lambda/aws-region/accountId/lambda-function-name
```

Under each log group, you see log streams with the following structure:

```
date/accountId/greengrass-group-id/name-of-core-that-generated-log
```

All AWS Greengrass core log entries use the following format:

```
[<timestamp>][<Log level>]-<error message>
```

## Logging Limitations<a name="gg-log-limits"></a>

AWS Greengrass has the following logging limitations\.

### Transactions per Second<a name="gg-log-limit-tps"></a>

When logging to CloudWatch is enabled, the logging component batches log events locally before sending them to CloudWatch, so you can log at a rate higher than five requests per second per log stream\.

### Memory<a name="gg-log-limit-mem"></a>

If AWS Greengrass is configured to send logs to CloudWatch and a Lambda function logs more than 5 MB/second for a prolonged period of time, the internal processing pipeline eventually fills up\. The theoretical worst case is 6 MB per Lambda function\. 

### Clock Skew<a name="gg-log-limit-skew"></a>

When logging to CloudWatch is enabled, the logging component signs requests to CloudWatch using the normal Signature Version 4 process\. If the system time on the AWS Greengrass core device is out of sync by more than [15 minutes](http://docs.aws.amazon.com/AmazonS3/latest/API/sig-v4-authenticating-requests.html), then the requests are rejected\.

### Disk Usage<a name="gg-log-limit-disk"></a>

Use the following formula to calculate the total maximum amount of disk usage for logging\. 

```
greengrass-storage * 7             // 6 if IP Detector is not used
  + 128KB                          // localwatch internal log
  + lambda-storage * lambda-count  // different versions of a lambda are treated as one
```

Where:

`greengrass-storage`  
The maximum amount of local storage for AWS Greengrass logs\.

`lambda-storage`  
The maximum amount of local storage for Lambda logs\.

`lambda-count`  
The number of deployed Lambda functions\.

### Log Loss<a name="gg-log-loss"></a>

If your AWS Greengrass core device is configured to log only to CloudWatch and there's no internet connectivity, you have no way to retrieve the logs currently in the memory\.

When Lambda functions are terminated \(for example, during deployment\), a few seconds worth of logs are not written to CloudWatch\.